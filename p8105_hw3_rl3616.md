p8105_hw3_rl3616
================
Ruipeng Li
2025-10-11

# Problem 1

Loading data

``` r
library(p8105.datasets)
library(ggplot2)
library(tidyverse)
library(patchwork) #Combining plot
data("instacart") 
```

#### Part a)

The Instacart dataset contains 1,384,617 observations and 15 variables,
representing individual items from customers’ grocery orders.

Each observation corresponds to one product within an order, with
variables describing the order time `order_hour_of_day`, date in week
`order_dow`, customer `user_id`, product details
`product_name, aisle, department`, and purchase behavior
`add_to_cart_order, reordered, days_since_prior_order`.

The dataset allows exploration of shopping habits such as the most
popular aisles, frequently reordered products, and peak shopping hours.

#### Part b)

Also, there are 134 different aisles in the dataset, and

``` r
top_aisles <- instacart |> 
  count(aisle, sort = TRUE)
top_aisles
```

    ## # A tibble: 134 × 2
    ##    aisle                              n
    ##    <chr>                          <int>
    ##  1 fresh vegetables              150609
    ##  2 fresh fruits                  150473
    ##  3 packaged vegetables fruits     78493
    ##  4 yogurt                         55240
    ##  5 packaged cheese                41699
    ##  6 water seltzer sparkling water  36617
    ##  7 milk                           32644
    ##  8 chips pretzels                 31269
    ##  9 soy lactosefree                26240
    ## 10 bread                          23635
    ## # ℹ 124 more rows

With this data, we can see the top 1 aisle that most items ordered from
was “fresh vegetables” and follow up with “fresh fruits” and “packaged
vegetables fruits”

#### Part c)

``` r
aisle_plot <- top_aisles |> 
  filter(n > 10000) |> 
  ggplot(aes(x = reorder(aisle, n), y = n)) +
  geom_col(width = 0.7, fill = "steelblue") +
  geom_text(aes(label = scales::comma(n)), 
            hjust = -0.1, size = 2.5) +
  coord_flip() +
  labs(
    title = "Aisles with more than 10,000 items ordered",
       x = "Aisle", y = "Number of items ordered"
    ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal(base_size = 8)
aisle_plot
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-3-1.png)<!-- -->

``` r
ggsave("figures/Problem 1/aisle_plot.png", aisle_plot, width = 10, dpi = 300)
```

According to the chart, we can see that `fresh vegetables` and
`fresh fruits` aisles have a discontinuous leading sales volume, while
`butter` has just exceeded the bottom line of 10,000.

#### Part d)

``` r
top_item_table <- instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  group_by(aisle, product_name) |>
  summarise(times_ordered = n()) |> 
  slice_max(times_ordered, n = 3)
top_item_table
```

    ## # A tibble: 9 × 3
    ## # Groups:   aisle [3]
    ##   aisle                      product_name                          times_ordered
    ##   <chr>                      <chr>                                         <int>
    ## 1 baking ingredients         Light Brown Sugar                               499
    ## 2 baking ingredients         Pure Baking Soda                                387
    ## 3 baking ingredients         Cane Sugar                                      336
    ## 4 dog food care              Snack Sticks Chicken & Rice Recipe D…            30
    ## 5 dog food care              Organix Chicken & Brown Rice Recipe              28
    ## 6 dog food care              Small Dog Biscuits                               26
    ## 7 packaged vegetables fruits Organic Baby Spinach                           9784
    ## 8 packaged vegetables fruits Organic Raspberries                            5546
    ## 9 packaged vegetables fruits Organic Blueberries                            4966

On the `baking ingredients aisle`, `Light Brown Sugar`,
`Pure Baking Soda`, and `Cane Sugar` are the three most frequently
purchased items.

On the `dog food care aisle`, the top three items are
`Snack Sticks Chicken & Rice Recipe Dog Treats`,
`Organix Chicken & Brown Rice Recipe`, and `Small Dog Biscuits`;
however, the overall number of purchases in this category is relatively
low compared to others.

On the `packaged vegetables and fruits aisle`, `Organic Baby Spinach`,
`Organic Raspberries`, and `Organic Blueberries` have the highest order
counts, with `Organic Baby Spinach` leading by a wide margin.

#### Part e)

``` r
mean_hour_table <- instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  group_by(product_name, order_dow) |> 
  summarise(mean_hour = mean(order_hour_of_day)) |> 
  mutate(order_dow = factor(order_dow,
    levels = 0:6,
    labels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
  )) |>
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hour
  )
mean_hour_table
```

    ## # A tibble: 2 × 8
    ## # Groups:   product_name [2]
    ##   product_name     Sunday Monday Tuesday Wednesday Thursday Friday Saturday
    ##   <chr>             <dbl>  <dbl>   <dbl>     <dbl>    <dbl>  <dbl>    <dbl>
    ## 1 Coffee Ice Cream   13.8   14.3    15.4      15.3     15.2   12.3     13.8
    ## 2 Pink Lady Apples   13.4   11.4    11.7      14.2     11.6   12.8     11.9

Overall, `Coffee Ice Cream` is very popular every day except `Friday`,
with an `mean order hour` of around 14 hours.

Meanwhile, `Pink Lady Apples` only has longer `mean order hour` on
`Sundays` and `Wednesdays`.

# Problem 2

#### Cleaning Zillow datasets(from homework 2)

``` r
zip_zori_df <- read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  janitor::clean_names() |>
  rename(zip_code = region_name) |> 
  select(-region_type, -state_name, -state, -city, -metro) |> 
  pivot_longer(
    cols = starts_with("x20"),
    names_to = "date",
    values_to = "rent_price"
  ) |> 
  filter(!is.na(rent_price)) |>
  mutate(
    county_name = str_replace(county_name, " County", ""),
    date = str_replace(date, "x", ""),
    date = ymd(date),
    year = lubridate::year(date),
    borough = case_when(
      county_name == "New York" ~ "Manhattan",
      county_name == "Kings" ~ "Brooklyn",
      county_name == "Queens" ~ "Queens",
      county_name == "Bronx" ~ "Bronx",
      county_name == "Richmond" ~ "Staten Island")
    ) |> 
   relocate("county_name","borough")
```

``` r
zip_count <- zip_zori_df |> 
  group_by(zip_code, county_name) |> 
  summarise(n_observed = n()) |> 
  arrange(desc(n_observed))
zip_count
```

    ## # A tibble: 149 × 3
    ## # Groups:   zip_code [149]
    ##    zip_code county_name n_observed
    ##       <dbl> <chr>            <int>
    ##  1    10001 New York           116
    ##  2    10002 New York           116
    ##  3    10003 New York           116
    ##  4    10005 New York           116
    ##  5    10010 New York           116
    ##  6    10012 New York           116
    ##  7    10013 New York           116
    ##  8    10014 New York           116
    ##  9    10017 New York           116
    ## 10    10018 New York           116
    ## # ℹ 139 more rows

Using this data, we can see there are 48 ZIP codes are observed 116
times, and there are 26 ZIP codes observed fewer than 10 times.

Using arranged data we can see almost all ZIPs in `Manhattan` and
`Brooklyn` appear 116 times; while many in `Staten Island` or the
`Bronx` might appear only a dozen or fewer times. I think it’s really
depends on population density. Which frequent appearances indicate rich
data and active listings; few appearances indicate an unpopular area, a
change in listings, or missing data.

#### Average rental price

``` r
mean_price <- zip_zori_df |> 
  group_by(year, borough) |> 
  summarise(average_price = mean(rent_price)) |> 
  pivot_wider(
    names_from = year,
    values_from = average_price
  )
mean_price
```

    ## # A tibble: 5 × 11
    ##   borough  `2015` `2016` `2017` `2018` `2019` `2020` `2021` `2022` `2023` `2024`
    ##   <chr>     <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>
    ## 1 Bronx     1760.  1520.  1544.  1639.  1706.  1811.  1858.  2054.  2285.  2497.
    ## 2 Brooklyn  2493.  2520.  2546.  2547.  2631.  2555.  2550.  2868.  3015.  3127.
    ## 3 Manhatt…  3022.  3039.  3134.  3184.  3310.  3107.  3137.  3778.  3933.  4078.
    ## 4 Queens    2215.  2272.  2263.  2292.  2388.  2316.  2211.  2406.  2562.  2694.
    ## 5 Staten …    NA     NA     NA     NA     NA   1978.  2045.  2147.  2333.  2536.

As we can clearly see in the table, the average rent in almost every
borough has gradually increased over the past nine years.

`Manhattan` is highest throughout and shows the largest absolute
increase (≈\$1k+ from 2015 to 2024).

`Brooklyn` also climbs strongly, narrowing part of the gap with Queens
after 2021.

In contrast, `Queens`, `Bronx` and `Staten Island` saw modest growth.

#### NYC Rental Prices by ZIP Code

``` r
rental_prices_plot <- ggplot(zip_zori_df, aes(x = date, y = rent_price, group = zip_code, color = borough)) +
  geom_line(alpha = 0.3) +
  facet_wrap(~ borough) +
  labs(
    title = "NYC Rental Prices by ZIP Code (2015–2024)",
    x = "Year", y = "Monthly Rent ($)", color = "Borough"
  ) +
  theme_minimal(base_size = 8) |> 
  theme(legend.position = "none")
rental_prices_plot
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

``` r
ggsave("figures/Problem 2/NYC Rental Prices.png")
```

Overall, `Brooklyn` and `Manhattan` have more listings and higher
prices, and `Manhattan` even have some extremely higher-priced zip
zones.

In addition, due to the COVID-19 pandemic in 2021, rents in these two
areas have generally decreased, with `Manhattan` being the most
noticeable (a huge dent). Meanwhile, rents in `Queens` haven’t been
affected much, and the `Bronx` has barely been affected.

``` r
# calculating rent_price 2023
rent_2023 <- zip_zori_df |> 
  filter(year == "2023") |> 
  group_by(borough, zip_code) |> 
  summarise(avg_rent_2023 = mean(rent_price, na.rm = TRUE))

# Making plot
rent_2023_plot <- ggplot(rent_2023, aes(x = avg_rent_2023, fill = borough)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of ZIP-Level Average Rent (2023)",
    x = "Average Monthly Rent ($)", y = "Density", fill = "Borough"
  ) +
  theme_minimal(base_size = 12)
rent_2023_plot
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-10-1.png)<!-- -->

``` r
ggsave("figures/Problem 2/rent_2023_plot.png")
```

Using this density plot, we can easily see the price ranges in which
rental prices in each borough are concentrated.

For example, almost all rental prices in `Staten Island` are
concentrated in the 2200-2600 range, so they appear very high peak in
the chart. In contrast, the charts for `Manhattan` and `Brooklyn` are
smooth, indicating that all types of rents appear. At the same time,
`Manhattan` rental price peaks at around 4300, while `Brooklyn` rental
prices peak at around 2700.

``` r
combined_plot <- (rental_prices_plot / rent_2023_plot) + 
  plot_layout(heights = c(2,3)) + 
  plot_annotation(
    title = "NYC Rental Price Overview",
    subtitle = "Top: Trends over Time (2015–2024) | Bottom: 2023 Price Distribution by Borough",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )  
combined_plot
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-11-1.png)<!-- -->

``` r
ggsave("results/Problem 2/combined_plot.png",
       width = 10, height = 12, dpi = 300)
```

# Problem 3

``` r
covar_df <- read_csv("data/nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names() |> 
  filter(age >= 21) |> 
  drop_na() |> 
  mutate(
    sex = recode(sex, "1" = "Male", "2" = "Female"),
    education = recode(education,
                       "1" = "Less than high school",
                       "2" = "High school equivalent",
                       "3" = "More than high school"),     # by definition in .csv file.
    education = factor(
      education,
      levels = c("Less than high school",
                 "High school equivalent",
                 "More than high school"),
      ordered = TRUE                                       # give order to levels
  ))

accel_df <- read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names()

nhanes_df <- covar_df |> 
  left_join(accel_df, by = "seqn")
```

#### Counting Male and Female.

``` r
sex_count_nhanes <- covar_df |>
  group_by(sex, education) |> 
  summarise(n = n()) |> 
  pivot_wider(names_from = sex, values_from = n) |> 
  arrange(education)
sex_count_nhanes
```

    ## # A tibble: 3 × 3
    ##   education              Female  Male
    ##   <ord>                   <int> <int>
    ## 1 Less than high school      28    27
    ## 2 High school equivalent     23    35
    ## 3 More than high school      59    56

Here we can see that among 228 participants, the ratio of `male` and
female for education level on `Less than high school` and
`More than high school` are almost same; however, in
`High school equivalent`, `male` are 1.52 times more than `females`.

#### Making density plot.

``` r
ggplot(covar_df, aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ education, ncol = 3) +
  labs(
    title = "Age Distributions by Education and Sex",
    x = "Age (years)",
    y = "Density"
  ) +
  theme_minimal()
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-14-1.png)<!-- -->

``` r
ggsave("figures/Problem 3/Age Distributions by Education and Sex.png")
```

Based on the figure, distinct age distribution patterns are observed
across education levels.

For participants with `less than high school` education, most are
concentrated above 40 years old. `Female` participants show a clear peak
near age 70, whereas `male` participants have two smaller peaks around
45 and 70 years, suggesting a bimodal distribution.

For those with a `high school equivalent` education, `males` are
relatively evenly distributed across ages, with slight peaks near 30 and
60 years. In contrast, `females` tend to be older on average, with the
highest density around 70 years.

Among participants with `more than high school` education, the majority
are younger, with ages primarily below 50. Both `males` and `females`
show a main peak near 30 years, though the proportion of `females` at
this age is much higher.

``` r
nhanes_total <- nhanes_df |>
  mutate(
    total_activity = rowSums(across(starts_with("min")), na.rm = TRUE)
  ) |>
  distinct(seqn, .keep_all = TRUE) |> 
  select(-starts_with("min"))
```

``` r
ggplot(nhanes_total, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE, method = "loess") +
  facet_wrap(~ education, ncol = 3) +
  labs(
    title = "Total Daily Activity vs Age by Sex and Education",
    x = "Age (years)",
    y = "total_activity",
    color = "Sex"
  ) +
  theme_minimal()
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-16-1.png)<!-- -->

``` r
ggsave("figures/Problem 3/Total Daily Activity vs Age by Sex.png")
```

The figure indicates that total daily activity declines with age across
all education levels. Among participants with
`high school equivalent or higher education`, `females` tend to have
slightly greater activity levels than `males`.

In contrast, within the `less than high school` group, `males` aged
40–80 show higher activity levels than `females`.

The wide variation in total activity across education levels suggests
more diverse lifestyle and occupational patterns.

Interestingly, younger adults (aged 20–30) with `less than high school`
education exhibit the highest overall activity levels, according to the
trend line.

While an individual 36-year-old `male` participant shows the lowest
total MIMS value in the dataset—possibly reflecting limited movement or
device-recording differences.

``` r
accel_long <- nhanes_df |>
  select(seqn, sex, education, starts_with("min")) |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "mims"
  ) |>
  mutate(
    minute = as.numeric(str_remove(minute, "min")),
    hour   = (minute - 1) %/% 60
  ) |>
  group_by(education, sex, hour) |>
  summarise(mean_mims = mean(mims, na.rm = TRUE), .groups = "drop")

ggplot(accel_long, aes(x = hour, y = mean_mims, color = sex)) +
  geom_line(linewidth = 1) +
  facet_wrap(~ education, ncol = 3) +
  labs(
    title = "24-hour Activity Patterns by Education Level and Sex",
    x = "Hour of Day",
    y = "Mean MIMs Activity",
    color = "Sex"
  ) +
  theme_minimal(base_size = 12)
```

![](p8105_hw3_rl3616_files/figure-gfm/unnamed-chunk-17-1.png)<!-- -->

``` r
ggsave("figures/Problem 3/24-hour Activity.png")
```

Based on the plot, the mean MIMS activity across all education levels
shows a clear daily rhythm — activity peaks between 7 AM and 8 PM,
corresponding to typical daytime hours, and drops sharply during the
night (around midnight to 5 AM).

This pattern aligns well with regular human sleep–wake cycles.

For participants with `high school or higher education`, `females`
consistently show higher mean hourly activity during the daytime
compared to `males`. In contrast, for those with `less than high school`
education, `male` and `female` activity levels are almost identical
throughout the day.

Interestingly, participants with `less than high school` education
display the highest daytime activity levels among all groups.

This may suggest that individuals with lower educational attainment
engage in more physically demanding occupations or routines, leading to
higher accelerometer readings during working hours.
